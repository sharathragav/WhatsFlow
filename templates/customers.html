{% extends "base.html" %}

{% block title %}Customer Management - WhatsApp Marketing{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">Customer Management</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-upload me-1"></i>Upload Excel
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                <i class="fas fa-plus me-1"></i>Add Customer
            </button>
        </div>
    </div>

    <!-- Customer Table -->
    <div class="dashboard-card">
        <div class="card-header">
            <h5 class="card-title mb-0">Customers ({{ customers|length }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="customersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td>{{ customer.name }}</td>
                            <td>{{ customer.phone }}</td>
                            <td>{{ customer.email or '-' }}</td>
                            <td>
                                <span class="status-badge status-opted-in">
                                    {{ customer.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewCustomer('{{ customer.id }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success me-1" onclick="editCustomer('{{ customer.id }}')" title="Edit Customer">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('{{ customer.id }}')" title="Delete Customer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No customers found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Upload Excel Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Customer Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">Excel File</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" required>
                        <div class="form-text">Upload Excel file with Customer data. Expected columns: Name, Phone, Email</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadExcel()">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerPhone" class="form-label">Phone</label>
                        <div class="country-code-group">
                            <select class="form-control country-code-select" id="countryCode">
                                <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                                <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                                <option value="+61">ðŸ‡¦ðŸ‡º +61</option>
                                <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
                                <option value="+33">ðŸ‡«ðŸ‡· +33</option>
                                <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
                                <option value="+81">ðŸ‡¯ðŸ‡µ +81</option>
                                <option value="+82">ðŸ‡°ðŸ‡· +82</option>
                                <option value="+55">ðŸ‡§ðŸ‡· +55</option>
                                <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
                                <option value="+7">ðŸ‡·ðŸ‡º +7</option>
                                <option value="+39">ðŸ‡®ðŸ‡¹ +39</option>
                                <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                                <option value="+31">ðŸ‡³ðŸ‡± +31</option>
                                <option value="+46">ðŸ‡¸ðŸ‡ª +46</option>
                                <option value="+47">ðŸ‡³ðŸ‡´ +47</option>
                                <option value="+45">ðŸ‡©ðŸ‡° +45</option>
                                <option value="+41">ðŸ‡¨ðŸ‡­ +41</option>
                                <option value="+43">ðŸ‡¦ðŸ‡¹ +43</option>
                                <option value="+32">ðŸ‡§ðŸ‡ª +32</option>
                                <option value="+48">ðŸ‡µðŸ‡± +48</option>
                                <option value="+90">ðŸ‡¹ðŸ‡· +90</option>
                                <option value="+62">ðŸ‡®ðŸ‡© +62</option>
                                <option value="+60">ðŸ‡²ðŸ‡¾ +60</option>
                                <option value="+65">ðŸ‡¸ðŸ‡¬ +65</option>
                                <option value="+66">ðŸ‡¹ðŸ‡­ +66</option>
                                <option value="+84">ðŸ‡»ðŸ‡³ +84</option>
                                <option value="+63">ðŸ‡µðŸ‡­ +63</option>
                                <option value="+92">ðŸ‡µðŸ‡° +92</option>
                                <option value="+880">ðŸ‡§ðŸ‡© +880</option>
                                <option value="+94">ðŸ‡±ðŸ‡° +94</option>
                                <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
                                <option value="+966">ðŸ‡¸ðŸ‡¦ +966</option>
                                <option value="+974">ðŸ‡¶ðŸ‡¦ +974</option>
                                <option value="+965">ðŸ‡°ðŸ‡¼ +965</option>
                                <option value="+27">ðŸ‡¿ðŸ‡¦ +27</option>
                                <option value="+234">ðŸ‡³ðŸ‡¬ +234</option>
                                <option value="+20">ðŸ‡ªðŸ‡¬ +20</option>
                                <option value="+254">ðŸ‡°ðŸ‡ª +254</option>
                                <option value="+256">ðŸ‡ºðŸ‡¬ +256</option>
                                <option value="+233">ðŸ‡¬ðŸ‡­ +233</option>
                                <option value="+212">ðŸ‡²ðŸ‡¦ +212</option>
                                <option value="+216">ðŸ‡¹ðŸ‡³ +216</option>
                                <option value="+213">ðŸ‡©ðŸ‡¿ +213</option>
                            </select>
                            <input type="tel" class="form-control" id="customerPhone" placeholder="Enter phone number" required>
                        </div>  
                    </div>
                    <div class="mb-3">
                        <label for="customerEmail" class="form-label">Email (Optional)</label>
                        <input type="email" class="form-control" id="customerEmail">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addCustomer()">Add Customer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- DataTables -->
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<style>
.country-code-group {
    display: flex;
    align-items: stretch;
}
.country-code-select {
    width: 120px;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    border-right: none;
}
.phone-input {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    flex: 1;
}
</style>

<script>
$(document).ready(function() {
    $('#customersTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[0, 'asc']]
    });
});

function viewCustomer(customerId) {
    // Fetch customer details and show in modal
    fetch(`/api/customers/${customerId}`)
        .then(response => response.json())
        .then(customer => {
            alert(`Customer Details:\nName: ${customer.name}\nPhone: ${customer.phone}\nEmail: ${customer.email}\nStatus: ${customer.status}\nCreated: ${customer.created_at}`);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load customer details');
        });
}

function editCustomer(customerId) {
    // For now, show a simple prompt - in production you'd use a proper modal
    fetch(`/api/customers/${customerId}`)
        .then(response => response.json())
        .then(customer => {
            const newName = prompt('Edit Name:', customer.name);
            const newPhone = prompt('Edit Phone:', customer.phone);
            const newEmail = prompt('Edit Email:', customer.email);
            
            if (newName && newPhone) {
                // Update customer
                fetch(`/api/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: newName,
                        phone: newPhone,
                        email: newEmail
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        alert('Customer updated successfully!');
                        location.reload(); // Refresh the page to show changes
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update customer');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load customer details');
        });
}

function deleteCustomer(customerId) {
    if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
        fetch(`/api/customers/${customerId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert('Customer deleted successfully!');
                location.reload(); // Refresh the page to show changes
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete customer');
        });
    }
}

function uploadExcel() {
    const fileInput = document.getElementById('excelFile');
    if (fileInput.files.length === 0) {
        alert('Please select a file');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    // Show loading state
    const uploadButton = document.querySelector('#uploadModal .btn-primary');
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
    
    fetch('/api/customers/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            let message = data.message;
            if (data.errors && data.errors.length > 0) {
                message += '\n\nWarnings:\n' + data.errors.slice(0, 5).join('\n');
                if (data.errors.length > 5) {
                    message += `\n... and ${data.errors.length - 5} more warnings.`;
                }
            }
            alert(message);
            location.reload(); // Refresh the page to show new customers
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to upload file');
    })
    .finally(() => {
        // Reset button state
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<i class="fas fa-upload me-1"></i>Upload';
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
        modal.hide();
    });
}

function addCustomer() {
    const name = document.getElementById('customerName').value;
    const countryCode = document.getElementById('countryCode').value;
    const phone = document.getElementById('customerPhone').value;
    const email = document.getElementById('customerEmail').value;
    
    if (!name || !phone) {
        alert('Name and Phone are required');
        return;
    }
    // Combine country code and phone number
    const fullPhone = countryCode + phone;

    // Show loading state
    const addButton = document.querySelector('#addCustomerModal .btn-success');
    addButton.disabled = true;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
    
    fetch('/api/customers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            phone: fullPhone,
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Customer added successfully!');
            location.reload(); // Refresh the page to show new customer
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add customer');
    })
    .finally(() => {
        // Reset button state
        addButton.disabled = false;
        addButton.innerHTML = '<i class="fas fa-plus me-1"></i>Add Customer';
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('addCustomerForm').reset();
    });
}
</script>
{% endblock %}
