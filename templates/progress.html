{% extends "base.html" %}

{% block title %}Progress Tracking - WhatsApp Marketing{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">Progress Tracking</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-danger" onclick="stopProcess()" id="stopBtn" style="display: none;">
                <i class="fas fa-stop me-1"></i>Stop Process
            </button>
            <button class="btn btn-outline-secondary" onclick="clearLogs()">
                <i class="fas fa-trash me-1"></i>Clear Logs
            </button>
        </div>
    </div>

    <!-- Quick Send Form -->
    <div class="dashboard-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-rocket me-2"></i>Quick Send Messages
            </h5>
        </div>
        <div class="card-body">
            <form id="quickSendForm" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="recipientsFile" class="form-label">Recipients Excel File</label>
                        <input type="file" class="form-control" id="recipientsFile" accept=".xlsx,.xls" required>
                        <div class="form-text">Excel file with Contact column and optional Message column</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="attachmentFile" class="form-label">Attachment (Optional)</label>
                        <input type="file" class="form-control" id="attachmentFile" 
                               accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.txt">
                        <div class="form-text">Optional file to send with messages</div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="startSending()" id="sendBtn">
                    <i class="fas fa-paper-plane me-1"></i>Start Sending
                </button>
            </form>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stat-card stat-card-blue">
                <div class="stat-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Total</div>
                    <div class="stat-number" id="totalCount">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card stat-card-yellow">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Current</div>
                    <div class="stat-number" id="currentCount">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card stat-card-green">
                <div class="stat-icon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Success</div>
                    <div class="stat-number" id="successCount">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card stat-card-red">
                <div class="stat-icon">
                    <i class="fas fa-times"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Failed</div>
                    <div class="stat-number" id="failureCount">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="dashboard-card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Overall Progress</h6>
                <span id="progressPercentage">0%</span>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Live Logs -->
    <div class="dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-terminal me-2"></i>Live Logs
            </h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                <label class="form-check-label" for="autoScroll">Auto-scroll</label>
            </div>
        </div>
        <div class="card-body">
            <div class="logs-container" id="logsContainer">
                <div class="log-entry log-info">
                    <span class="log-timestamp">[--:--:--]</span>
                    <span class="log-message">Ready to start sending messages. Upload a recipients file to begin.</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/progress-tracker.js') }}"></script>
<script>
let progressTracker;
let isProcessActive = false;

document.addEventListener('DOMContentLoaded', function() {
    // Check if ProgressTracker is available
    if (typeof ProgressTracker !== 'undefined') {
        progressTracker = new ProgressTracker();
    } else {
        console.error('ProgressTracker not available');
    }
    
    // Initialize file upload handlers
    initializeFileUpload();
});

function initializeFileUpload() {
    const recipientsFile = document.getElementById('recipientsFile');
    const attachmentFile = document.getElementById('attachmentFile');
    
    recipientsFile.addEventListener('change', function() {
        validateFile(this, ['xlsx', 'xls']);
    });
    
    attachmentFile.addEventListener('change', function() {
        validateFile(this, ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'doc', 'docx', 'txt']);
    });
}

function validateFile(input, allowedExtensions) {
    const file = input.files[0];
    if (!file) return;
    
    const extension = file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(extension)) {
        alert(`Invalid file type. Allowed: ${allowedExtensions.join(', ')}`);
        input.value = '';
        return;
    }
    
    // Check file size (16MB limit)
    if (file.size > 16 * 1024 * 1024) {
        alert('File size must be less than 16MB');
        input.value = '';
        return;
    }
}

async function startSending() {
    const recipientsFile = document.getElementById('recipientsFile').files[0];
    const attachmentFile = document.getElementById('attachmentFile').files[0];
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    
    if (!recipientsFile) {
        alert('Please select a recipients file');
        return;
    }
    
    // Prepare form data
    const formData = new FormData();
    formData.append('recipientsFile', recipientsFile);
    if (attachmentFile) {
        formData.append('attachmentFile', attachmentFile);
    }
    
    try {
        // Update UI
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Starting...';
        stopBtn.style.display = 'inline-block';
        isProcessActive = true;
        
        // Clear previous logs
        clearLogs();
        addLogEntry('Starting message sending process...', 'info');
        
        // Start the sending process
        const response = await fetch('/api/send', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to start sending process');
        }
        
        addLogEntry(data.message, 'success');
        
        // Start monitoring progress
        progressTracker.startMonitoring();
        
    } catch (error) {
        addLogEntry(`Error: ${error.message}`, 'error');
        resetUI();
    }
}

function stopProcess() {
    if (confirm('Are you sure you want to stop the sending process?')) {
        isProcessActive = false;
        progressTracker.stopMonitoring();
        addLogEntry('Process stopped by user', 'warning');
        resetUI();
    }
}

function resetUI() {
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Start Sending';
    stopBtn.style.display = 'none';
    isProcessActive = false;
}

function clearLogs() {
    const logsContainer = document.getElementById('logsContainer');
    logsContainer.innerHTML = '';
    
    // Reset counters
    document.getElementById('totalCount').textContent = '0';
    document.getElementById('currentCount').textContent = '0';
    document.getElementById('successCount').textContent = '0';
    document.getElementById('failureCount').textContent = '0';
    document.getElementById('progressPercentage').textContent = '0%';
    document.getElementById('progressBar').style.width = '0%';
}

function addLogEntry(message, type = 'info') {
    const logsContainer = document.getElementById('logsContainer');
    const timestamp = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-message">${message}</span>
    `;
    
    logsContainer.appendChild(logEntry);
    
    // Auto-scroll if enabled
    if (document.getElementById('autoScroll').checked) {
        logEntry.scrollIntoView({ behavior: 'smooth' });
    }
}

function updateProgress(current, total, successCount, failureCount) {
    document.getElementById('totalCount').textContent = total;
    document.getElementById('currentCount').textContent = current;
    document.getElementById('successCount').textContent = successCount;
    document.getElementById('failureCount').textContent = failureCount;
    
    const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
    document.getElementById('progressPercentage').textContent = `${percentage}%`;
    document.getElementById('progressBar').style.width = `${percentage}%`;
}

// Progress tracker class
class ProgressTracker {
    constructor() {
        this.monitoringInterval = null;
    }
    
    startMonitoring() {
        this.monitoringInterval = setInterval(() => {
            this.checkProgress();
        }, 2000); // Check every 2 seconds
    }
    
    stopMonitoring() {
        if (this.monitoringInterval) {
            clearInterval(this.monitoringInterval);
            this.monitoringInterval = null;
        }
    }
    
    async checkProgress() {
        try {
            const response = await fetch('/api/progress');
            const data = await response.json();
            
            // Update progress display
            updateProgress(data.current, data.total, data.success_count, data.failure_count);
            
            // Add new log entries
            if (data.logs && data.logs.length > 0) {
                const currentLogCount = document.querySelectorAll('.log-entry').length;
                const newLogs = data.logs.slice(currentLogCount - 1); // Get only new logs
                
                newLogs.forEach(log => {
                    let type = 'info';
                    if (log.includes('✓') || log.includes('Success')) type = 'success';
                    if (log.includes('✗') || log.includes('Failed') || log.includes('Error')) type = 'error';
                    if (log.includes('Warning')) type = 'warning';
                    
                    addLogEntry(log, type);
                });
            }
            
            // Check if process is complete
            if (!data.is_active && isProcessActive) {
                this.stopMonitoring();
                addLogEntry('Process completed!', 'success');
                resetUI();
            }
            
        } catch (error) {
            console.error('Error checking progress:', error);
        }
    }
}
</script>
{% endblock %}
